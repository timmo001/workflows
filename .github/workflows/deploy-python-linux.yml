---
name: Deploy Python Linux

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      additional-artifacts-name:
        required: false
        type: string
      additional-artifacts-path:
        required: false
        type: string
      code-path:
        required: false
        type: string
        default: "."
      module-name:
        required: true
        type: string
      pre-install-command:
        required: false
        type: string
      use-incremental:
        required: false
        type: boolean
        default: false
    secrets:
      PYPI_USERNAME:
        required: true
      PYPI_PASSWORD:
        required: true

jobs:
  deploy-python-linux:
    name: 🚀 Deploy Application - Linux
    runs-on: ubuntu-latest
    steps:
      - name: ⤵️ Check out code from GitHub
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
      - name: ⬇️ Download additional artifacts
        uses: actions/download-artifact@v3
        if: ${{ inputs.additional-artifacts-name }}
        with:
          name: ${{ inputs.additional-artifacts-name }}
          path: ${{ inputs.additional-artifacts-path }}
      - name: 🏗 Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          architecture: "x64"
          cache: "pip"
      - name: 🏗 Install setuptools, wheel, twine, click, twisted, incremental
        run: |
          pip install --upgrade setuptools wheel twine click twisted incremental
      - name: 🚀 Run pre-install-command
        if: ${{ inputs.pre-install-command }}
        run: |
          cd ${{ inputs.code-path }}
          ${{ inputs.pre-install-command }}
      - name: 🔢 Increment version - Developement
        if: ${{ inputs.use-incremental && github.event_name != 'release' }}
        run: |
          cd ${{ inputs.code-path }}
          python -m incremental.update ${{ inputs.module-name }} \
            --dev
      - name: 🔢 Increment version - Release
        if: ${{ inputs.use-incremental && github.event_name == 'release' }}
        run: |
          cd ${{ inputs.code-path }}
          python -m incremental.update ${{ inputs.module-name }} \
            --newversion=${{ github.event.release.tag_name }}
      - name: 🔢 Get version
        id: get-version
        if: ${{ inputs.use-incremental }}
        run: |
          cd ${{ inputs.code-path }}
          result=$(python <<EOF
          from ${{ inputs.module-name }}._version import __version__
          print(__version__.public())
          EOF
          )
          echo ::set-output name=version::"$result"
      - name: Test
        run: |
          echo "${{ inputs.module-name }}"
          echo "${{ steps.get-version.outputs.version }}"
      - name: 🖊 Commit
        uses: EndBug/add-and-commit@v9
        if: ${{ inputs.use-incremental }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          pull: "--rebase --autostash ..."
          message: |
            Bump ${{ inputs.module-name }} version to ${{ steps.get-version.outputs.version }}
      # - name: 🏗 Install package
      #   run: |
      #     cd ${{ inputs.code-path }}
      #     python setup.py sdist bdist_wheel
      # - name: 🚀 Publish to PyPI
      #   env:
      #     TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
      #     TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      #   run: |
      #     cd ${{ inputs.code-path }}
      #     twine upload dist/*
