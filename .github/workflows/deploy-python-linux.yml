---
name: "Deploy Python Module Linux"

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      additional-artifacts-name:
        required: false
        type: string
      additional-artifacts-path:
        required: false
        type: string
      code-path:
        required: false
        type: string
        default: "."
      module-name:
        required: true
        type: string
      pre-install-command:
        required: false
        type: string
      use-incremental:
        required: false
        type: boolean
        default: false
    secrets:
      PUSH_TOKEN:
        required: true
      PYPI_USERNAME:
        required: true
      PYPI_PASSWORD:
        required: true

jobs:
  deploy-python-linux:
    name: ğŸš€ Linux - Deploy Module
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v4.1.1
        with:
          ref: "master"
          token: ${{ secrets.PUSH_TOKEN }}
      - name: â¬‡ï¸ Download additional artifacts
        uses: actions/download-artifact@v4.1.0
        if: ${{ inputs.additional-artifacts-name }}
        with:
          name: ${{ inputs.additional-artifacts-name }}
          path: ${{ inputs.additional-artifacts-path }}
      - name: ğŸ— Set up Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: "3.12"
          architecture: "x64"
          cache: "pip"
      - name: ğŸ— Install setuptools, wheel, twine, click, twisted, incremental
        run: |
          pip install --upgrade setuptools wheel twine click twisted incremental
      - name: ğŸš€ Run pre-install-command
        if: ${{ inputs.pre-install-command }}
        run: |
          cd ${{ inputs.code-path }}
          ${{ inputs.pre-install-command }}
      - name: ğŸ”¢ Get old version
        id: get-version-old
        if: ${{ inputs.use-incremental }}
        run: |
          cd ${{ inputs.code-path }}

          # Read version from _version.py
          result=$(python <<EOF
          from ${{ inputs.module-name }}._version import __version__
          print(__version__.public())
          EOF
          )

          echo "version=$result" >> $GITHUB_OUTPUT
      - name: ğŸ”¢ Set correct vertion - Developement
        if: ${{ inputs.use-incremental && github.event_name != 'release' }}
        run: |
          cd ${{ inputs.code-path }}
          # If version does not contain dev, add it
          if [[ ! "${{ steps.get-version-old.outputs.version }}" == *"dev"* ]]; then
            python -m incremental.update ${{ inputs.module-name }} --dev
          fi
      - name: ğŸ”¢ Set correct vertion - Release
        if: ${{ inputs.use-incremental && github.event_name == 'release' }}
        run: |
          cd ${{ inputs.code-path }}
          # If version contains dev*, remove it
          if [[ "${{ steps.get-version-old.outputs.version }}" == *"dev"* ]]; then
            NEW_VERSION=$(echo "${{ steps.get-version-old.outputs.version }}" | sed 's/.dev.*//')
            python -m incremental.update ${{ inputs.module-name }} --newversion $NEW_VERSION
          fi
      - name: ğŸ”¢ Get current version
        id: get-version-current
        if: ${{ inputs.use-incremental }}
        run: |
          cd ${{ inputs.code-path }}
          result=$(python <<EOF
          from ${{ inputs.module-name }}._version import __version__
          print(__version__.public())
          EOF
          )
          echo "version=$result" >> $GITHUB_OUTPUT
      - name: â¤µï¸ Pull latest changes from GitHub
        if: ${{ inputs.use-incremental }}
        run: |
          git pull --ff
      - name: ğŸ–Š Commit
        if: ${{ inputs.use-incremental }}
        uses: stefanzweifel/git-auto-commit-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        with:
          commit_message: |
            Bump ${{ inputs.module-name }} version to ${{ steps.get-version-current.outputs.version }}
      - name: ğŸ— Install package
        run: |
          cd ${{ inputs.code-path }}
          python setup.py sdist bdist_wheel
      - name: ğŸš€ Publish to PyPI
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          cd ${{ inputs.code-path }}
          python --version
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools wheel twine
          twine upload dist/*
          echo "Successfully deployed ${{ inputs.module-name }} ${{ steps.get-version-old.outputs.version }}" >> $GITHUB_STEP_SUMMARY
      - name: ğŸ”¢ Increment version - Developement
        if: ${{ inputs.use-incremental && github.event_name != 'release' }}
        run: |
          cd ${{ inputs.code-path }}
          python -m incremental.update ${{ inputs.module-name }} --dev
      - name: ğŸ”¢ Increment version - Release
        if: ${{ inputs.use-incremental && github.event_name == 'release' }}
        run: |
          cd ${{ inputs.code-path }}
          python -m incremental.update ${{ inputs.module-name }} --patch
          python -m incremental.update ${{ inputs.module-name }} --dev
      - name: ğŸ”¢ Get new version
        id: get-version-new
        if: ${{ inputs.use-incremental }}
        run: |
          cd ${{ inputs.code-path }}
          result=$(python <<EOF
          from ${{ inputs.module-name }}._version import __version__
          print(__version__.public())
          EOF
          )
          echo "version=$result" >> $GITHUB_OUTPUT
      - name: â¤µï¸ Pull latest changes from GitHub
        if: ${{ inputs.use-incremental }}
        run: |
          git pull --ff
      - name: ğŸ–Š Commit
        if: ${{ inputs.use-incremental }}
        uses: stefanzweifel/git-auto-commit-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        with:
          commit_message: |
            Bump ${{ inputs.module-name }} version to ${{ steps.get-version-new.outputs.version }}
