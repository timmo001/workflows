---
name: Package Python Application Linux

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      additional-pyinstaller-options:
        required: false
        type: string
      create-setup:
        required: false
        type: boolean
        default: false
      entry-point-file:
        required: true
        type: string
      pre-package-command:
        required: false
        type: string

jobs:
  package-python-linux:
    name: ğŸš€ Linux - Package Python Application
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ github.head_ref }}
      - name: ğŸ— Set up Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: "3.12"
          architecture: "x64"
          cache: "pip"
      - name: ğŸ— Install dependencies
        run: |
          sudo apt update
          sudo apt install libavahi-compat-libdnssd-dev libegl-dev libpulse0
          wget https://github.com/goreleaser/nfpm/releases/download/v2.15.1/nfpm_amd64.deb
          sudo apt install ./nfpm_amd64.deb
          rm ./nfpm_amd64.deb
      - name: ğŸ— Install setuptools, wheel, pyinstaller
        run: |
          pip install --upgrade setuptools wheel pyinstaller
      - name: ğŸš€ Run pre-package-command
        if: ${{ inputs.pre-package-command }}
        run: |
          ${{ inputs.pre-package-command }}
      - name: ğŸ“¦ Create executable
        run: >
          pyinstaller \
            --clean \
            --noconfirm \
            ${{ inputs.additional-pyinstaller-options }} \
            ${{ inputs.entry-point-file }}
      - name: â¬†ï¸ Upload Artifacts - dist
        uses: actions/upload-artifact@v3.1.3
        with:
          name: linux-dist
          path: dist/
      - name: ğŸš€ Create apk file
        if: ${{ inputs.create-setup }}
        run: |
          nfpm package --config nfpm.yml --packager apk
      - name: â¬†ï¸ Upload Artifacts - apk
        if: ${{ inputs.create-setup }}
        uses: actions/upload-artifact@v3.1.3
        with:
          name: linux-apk
          path: "*.apk"
      - name: ğŸš€ Create deb file
        if: ${{ inputs.create-setup }}
        run: |
          nfpm package --config nfpm.yml --packager deb
      - name: â¬†ï¸ Upload Artifacts - deb
        if: ${{ inputs.create-setup }}
        uses: actions/upload-artifact@v3.1.3
        with:
          name: linux-deb
          path: "*.deb"
      - name: ğŸš€ Create rpm file
        if: ${{ inputs.create-setup }}
        run: |
          nfpm package --config nfpm.yml --packager rpm
      - name: â¬†ï¸ Upload Artifacts - rpm
        if: ${{ inputs.create-setup }}
        uses: actions/upload-artifact@v3.1.3
        with:
          name: linux-rpm
          path: "*.rpm"
      - name: â¬†ï¸ Upload to Release Assets - apk
        if: ${{ inputs.create-setup && github.event_name == 'release' }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.apk
            *.deb
            *.rpm
